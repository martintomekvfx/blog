name: Tweet New Post

# Triggers on push to main, only when posts change
on:
  push:
    branches: [main]
    paths:
      - "src/content/posts/**"

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect new posts
        id: detect
        run: |
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD -- 'src/content/posts/*.mdx' 'src/content/posts/*.md' || true)
          if [ -z "$NEW_FILES" ]; then
            echo "No new posts found."
            echo "has_new=false" >> "$GITHUB_OUTPUT"
          else
            echo "New posts: $NEW_FILES"
            echo "has_new=true" >> "$GITHUB_OUTPUT"
            echo "file=$(echo "$NEW_FILES" | head -1)" >> "$GITHUB_OUTPUT"
          fi

      - name: Parse frontmatter and tweet
        if: steps.detect.outputs.has_new == 'true'
        env:
          # Set these secrets in your repo settings:
          # Settings > Secrets and variables > Actions > New repository secret
          #
          # You need a X/Twitter Developer account with OAuth 1.0a credentials:
          # 1. Go to https://developer.twitter.com/en/portal/dashboard
          # 2. Create a project & app
          # 3. Generate API Key, API Secret, Access Token, Access Secret
          # 4. Add them as repository secrets with the names below
          TWITTER_API_KEY: ${{ secrets.TWITTER_API_KEY }}
          TWITTER_API_SECRET: ${{ secrets.TWITTER_API_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_SECRET: ${{ secrets.TWITTER_ACCESS_SECRET }}
        run: |
          FILE="${{ steps.detect.outputs.file }}"

          # Extract frontmatter fields
          TITLE=$(sed -n 's/^title: *"\(.*\)"/\1/p' "$FILE" | head -1)
          DESCRIPTION=$(sed -n 's/^description: *"\(.*\)"/\1/p' "$FILE" | head -1)
          TAGS=$(grep -oP '(?<=\[)[^\]]+' <<< "$(sed -n 's/^tags: *//p' "$FILE")" | tr -d '"' | tr ',' '\n' | sed 's/^ *//' | sed 's/^/#/' | tr '\n' ' ')

          # Build post URL from filename
          SLUG=$(basename "$FILE" | sed 's/\.[^.]*$//')
          URL="https://martintomekvfx.github.io/blog/posts/${SLUG}/"

          TWEET="${TITLE} â€” ${DESCRIPTION} ${URL} ${TAGS}"

          # Trim to 280 chars
          TWEET=$(echo "$TWEET" | cut -c1-280)

          echo "Tweet: $TWEET"

          # Post using X API v2 with OAuth 1.0a (via curl + oauth header)
          pip install requests requests-oauthlib -q

          python3 - <<PYEOF
          import os, json
          from requests_oauthlib import OAuth1Session

          twitter = OAuth1Session(
              os.environ["TWITTER_API_KEY"],
              client_secret=os.environ["TWITTER_API_SECRET"],
              resource_owner_key=os.environ["TWITTER_ACCESS_TOKEN"],
              resource_owner_secret=os.environ["TWITTER_ACCESS_SECRET"],
          )

          payload = {"text": """$TWEET"""}
          resp = twitter.post("https://api.twitter.com/2/tweets", json=payload)
          print(f"Status: {resp.status_code}")
          print(resp.json())
          PYEOF
