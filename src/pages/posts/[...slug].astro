---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PostView from "../../components/PostView.jsx";
import { db } from "../../lib/firebase";
import { collection, getDocs, query, where } from "firebase/firestore";

export async function getStaticPaths() {
  try {
    const snap = await getDocs(
      query(collection(db, "posts"), where("draft", "==", false))
    );

    return snap.docs.map((docSnap) => {
      const data = docSnap.data();
      return {
        params: { slug: docSnap.id },
        props: {
          slug: docSnap.id,
          title: String(data.title || "Untitled"),
          description: String(data.description || ""),
          author: String(data.author || "Martin Tomek"),
          heroImage: String(data.heroImage || "/blog/favicon.svg"),
          pubDate: String(data.pubDate || ""),
        },
      };
    });
  } catch {
    return [];
  }
}

const { slug, title, description, author, heroImage, pubDate } = Astro.props;

const parsedDate = new Date(pubDate || "");
const publishedIso = Number.isNaN(parsedDate.getTime())
  ? ""
  : parsedDate.toISOString();
---

<BaseLayout
  title={`${title} | Blog`}
  description={description || "A blog post"}
  image={heroImage || "/blog/favicon.svg"}
  ogType="article"
  author={author}
>
  <meta slot="head" property="article:author" content={author} />
  {publishedIso && (
    <meta slot="head" property="article:published_time" content={publishedIso} />
  )}

  <PostView client:load slug={slug} />
</BaseLayout>
