---
import BaseLayout from "../layouts/BaseLayout.astro";

const buttondownUsername = import.meta.env.PUBLIC_BUTTONDOWN_USERNAME;
const hasButtondown = Boolean(buttondownUsername);
const buttondownAction = hasButtondown
  ? `https://buttondown.com/api/emails/embed-subscribe/${buttondownUsername}`
  : "";
const buttondownLanding = hasButtondown
  ? `https://buttondown.com/${buttondownUsername}`
  : "";
---

<BaseLayout
  title="Newsletter | Martin Tomek"
  description="Subscribe to receive new Martin Tomek posts by email."
>
  <section class="max-w-2xl">
    <h1 class="text-3xl font-bold text-balance mb-2">Newsletter</h1>
    <p class="opacity-70 mb-8 text-pretty">
      New writing on art, VFX, tactical urbanism, and open tools â€” sent when there is
      something worth reading.
    </p>

    {hasButtondown ? (
      <form
        action={buttondownAction}
        method="post"
        target="popupwindow"
        onsubmit={`window.open('${buttondownLanding}', 'popupwindow')`}
        class="border border-black p-4 sm:p-6"
      >
        <label for="bd-email" class="block text-xs uppercase tracking-[0.1em] mb-2">
          Email address
        </label>
        <div class="flex flex-col sm:flex-row gap-2">
          <input
            id="bd-email"
            type="email"
            name="email"
            required
            placeholder="you@example.com"
            class="flex-1 border border-black px-3 py-2 text-sm focus:outline-none"
          />
          <input type="hidden" name="embed" value="1" />
          <button
            type="submit"
            class="border border-black px-4 py-2 text-xs uppercase font-medium hover:bg-black hover:text-white transition-colors duration-100"
          >
            Subscribe
          </button>
        </div>
      </form>
    ) : (
      <div class="border border-black p-4 sm:p-6">
        <p class="text-sm">
          Newsletter provider is not configured yet.
        </p>
        <p class="text-sm opacity-70 mt-2">
          Set <code>PUBLIC_BUTTONDOWN_USERNAME</code> to enable the subscribe form.
        </p>

        <ol class="mt-4 space-y-2 text-sm list-decimal pl-5 opacity-80">
          <li>Create a free account on Buttondown.</li>
          <li>Set <code>PUBLIC_BUTTONDOWN_USERNAME</code> in your environment.</li>
          <li>Redeploy so the embedded subscribe form becomes active.</li>
          <li>
            Optional: connect your publish automation so each new post sends email + X update.
          </li>
        </ol>
      </div>
    )}

    <p class="text-sm opacity-70 mt-6">
      Prefer feeds/automation? RSS is still available at
      <a href="/blog/rss.xml" class="underline underline-offset-4">/blog/rss.xml</a>.
    </p>
  </section>
</BaseLayout>
